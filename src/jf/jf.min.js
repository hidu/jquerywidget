(function($){window.jf=window.jf||{};if(window.jf.version){return;}window.jf={version:"20110920",toString:function(){return"form kit "+this.version;},loading:function(target){var t=$(target),h=t.height();if(h<70){h=80;}else{if(h>500){h=300;}}t.empty().html("<div class='jf_loading' style='height:"+h+"px;padding-top:"+(h-70)/2+"px;'>正在加载...<div>&nbsp;</div></div>");},form:function(formID,targetID,sucFn,ext){if($.isFunction(targetID)){ext=sucFn;sucFn=targetID;targetID=null;}if(!$.isFunction(sucFn)){ext=sucFn;sucFn="";}ext=$.extend({},{dataType:null,delay:0,validate:true,timeout:30000,validate:{},before:null},ext||{});var that=this,form=$(formID),submitEnable=function(enable){form.find(":submit").attr("disabled",!enable);};form.find(":reset").click(function(){var title=$(this).attr("title");if(title.length&&false===confirm(title)){return false;}submitEnable(true);form.resetForm();form.find(":input").trigger("reset");return false;});form.find(":text").bind("change",function(){$(this).val($.trim($(this).val()));});var showRequest=function(formData,jqForm,options){if(ext.before){if(ext.dataType==null){ext.dataType="json";}if(false===ext.before.call(jqForm)){return false;}}submitEnable(false);targetID&&that.loading(targetID);};var options={target:targetID,beforeSubmit:showRequest,timeout:ext.timeout,dataType:ext.dataType,success:function(data){submitEnable(true);$.isFunction(sucFn)&&sucFn.call(form,data);},beforeSend:function(xml){try{xml.setRequestHeader("dq",window.screen.height+"/"+window.screen.width);}catch(e){}},error:function(a,b,c){submitEnable(true);targetID&&$(targetID).html("load failed "+a.responseText);}};function _reg_form(){if(ext.validate!==false&&$.validator){var validateOpt={submitHandler:function(){form.ajaxSubmit(options);}};$.extend(validateOpt,ext.validate);form.validate(validateOpt);}else{form.submit(function(){$(this).ajaxSubmit(options);return false;});}}if(ext.delay){$().ready(function(){setTimeout(_reg_form,ext.delay);});}else{_reg_form();}return form;},ajaxLink:function(linkSelector,targetID){var that=this,target=$(targetID);if(!target.size()){return false;}$(linkSelector).die("click").live("click",function(){var rel=$(this).attr("href");if(!rel){return;}that.centerIt(target);that.loading(targetID);target.attr("rel",rel).load(rel);return false;});},pager:function(pagerID,targetID){this.ajaxLink($(pagerID||".pager").find("a"),targetID);},centerIt:function(target){var y=$(target).offset().top;var h=$(window).height();if(y>window.scrollY+0.75*h||y<window.scrollY){window.scrollTo(window.scrollX,y-20);}},checkAll:function(targetClass,type){if(typeof type=="object"){if($(type).attr("checked")){type=1;}else{type=0;}}if(0==type){$(targetClass).attr("checked",false);}else{if(1==type){$(targetClass).attr("checked",true);}else{if(2==type){$(targetClass).each(function(){$(this).attr("checked",!($(this).attr("checked")));});}else{if(9==type){return $.map($(targetClass+":checked"),function(n){return $(n).val();});}}}}},trSelect:function(tableSelector){var table=$(tableSelector||"table"),fn=function(){table.find("tr").removeClass("jf_select");$(this).parents("tr").addClass("jf_select");};table.find("tbody td *").bind("click",fn);table.find("tbody td").bind("dblclick",fn);},ajaxFile:function(formID,beforeFn,sucFn,option){option=option||{};option.fileExt=option.fileExt||["bmp","jpg","jpeg","png","gif"];var isAllow=function(f){var i=f.lastIndexOf("."),ext=i>=0?f.substring(i+1,f.length).toLowerCase():"";var isOk=$.inArray(ext,option.fileExt)>-1;if(!isOk){alert("文件:\n"+f+"\n不被支持！\n请选择后缀为"+option.fileExt.join()+"的文件");}return isOk;};var form=$(formID),file=form.find(":file"),fobj=file[0],checkFileExt=function(){if(fobj.multiple){for(var j=0;j<fobj.files.length;j++){var _f=fobj.files[j].name;if(!isAllow(_f)){file.val("");return false;}}}else{if(!isAllow(file.val())){file.val("");return false;}}return true;};var st=true;file.change(function(){if(file.val().length>0){st=checkFileExt();}});form.ajaxForm({beforeSubmit:function(formData,jqForm,options){var f=file.val();if(f.length<1){alert("请选择要上传的文件");return false;}if(false===checkFileExt()){return false;}if((typeof beforeFn=="function")&&false===beforeFn.call(jqForm)){return false;}},dataType:option.dataType||"json",success:function(data){if(typeof sucFn=="function"){sucFn.call(form,data);}},error:function(xhr,textStatus,errorThrown){alert("something wrong!\n\n"+xhr.responseText);}});if(option.autoSubmit){file.change(function(){st&&file.val().length&&form.submit();});}return form;},optionToSelect:function(value,text,select){$('<option value="'+value+'">'+text+"</option>").appendTo(select);},relation:function(first,second,values,ctxt){var t=$(second),that=this;$(first).change(function(){var v=$(this).val(),_v=t.find("option:selected").val(),nextAll="";if(values&&(typeof values)=="string"){$.getJSON(values+v,function(data){nextAll=data;fill();});}else{nextAll=values?(values[v]||""):"";fill();}function fill(){t.empty();ctxt&&that.optionToSelect("",ctxt,t);$.each(nextAll,function(i,txt){that.optionToSelect(i,txt,t);});if(_v&&nextAll[_v]){t.val(_v);}t.change();}}).change();},findByName:function(name,doc){return jQuery(document.getElementsByName(name),doc||"*").map(function(index,element){return element.name==name&&element||null;});}};})(jQuery);